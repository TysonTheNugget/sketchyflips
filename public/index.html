<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 Sketchy Dapps 🎲</title>
</head>
<body>
    <header>
        <h1>🎮 Sketchy Dapps 🎲</h1>
        <p>Fun, friends, NFTs!</p>
    </header>

    <main>
        <section>
            <h2>Bet-A-Sketchy</h2>
            <p><i>Mymilio Daycare</i></p>
        </section>

        <nav>
            <ul>
                <li><a href="#">Home</a></li>
            </ul>
        </nav>

        <section>
            <button id="connectWallet">🔌 Connect Wallet</button>
            <p id="accountInfo">Account: Not connected</p>

            <div>
                <p>Selected NFT: <span>Your Sketchy</span></p>
                <button>🎯 Select NFT</button>
            </div>

            <button>🎰 Create Game</button>
            <div>
                <p>🎯 Open Games</p>
            </div>

            <p>Status: Waiting...</p>
        </section>
    </main>

    <footer>
        <div id="aboutModal">
            <span>×</span>
            <h3>About Bet-A-Sketchy</h3>
            <p>50% chance PVP to win a Sketchy by betting one, verified by Gelato.</p>
            <p><a href="#">ABScan</a> | <a href="#">More Info</a></p>
        </div>

        <div id="selectNFTModal">
            <span>×</span>
            <h3>Select NFT</h3>
        </div>

        <div id="resultsModal">
            <span>×</span>
            <h3>Game Results</h3>
            <div id="resultsModalList"></div>
        </div>

        <div id="videoOverlay" class="hidden">
            <video id="resultVideo"></video>
            <p id="resultText"></p>
            <div id="animationNFTs"></div>
        </div>
    </footer>

    <div>
        <p>Loading SketchyMilios...</p>
    </div>

    <section>
        <button id="resultsButton">Results</button>
        <p>0</p>
    </section>

    <script type="module">
        import { ethers } from "https://cdn.skypack.dev/ethers@5.7.2";
        const gameAddress = "0xf6b8d2E0d36669Ed82059713BDc6ACfABe11Fde6";
        const gameABI = [
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)"
        ];
        let provider, account;
        // DOM refs
        const resultsButton = document.getElementById("resultsButton");
        const resultsModal = document.getElementById("resultsModal");
        const resultsList = document.getElementById("resultsModalList");
        const resultVideo = document.getElementById("resultVideo");
        const videoOverlay = document.getElementById("videoOverlay");
        const resultText = document.getElementById("resultText");
        const animationNFTs = document.getElementById("animationNFTs");
        document.getElementById("connectWallet").addEventListener("click", async () => {
            if (!window.ethereum) return alert("Install MetaMask");
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            account = await provider.getSigner().getAddress();
            document.getElementById("accountInfo").textContent = `Account: ${account.slice(0,6)}...${account.slice(-4)}`;
        });
        resultsButton.addEventListener("click", async () => {
            if (!account || !provider) return alert("Connect wallet first");
            resultsModal.classList.remove("hidden");
            resultsList.innerHTML = `<button class="neon-button w-full mb-2" id="refreshResults">🔄 Refresh</button><p class="text-sm text-center italic">Loading...</p>`;
            document.getElementById("refreshResults").addEventListener("click", () => {
                scanChainResults();
            });
            scanChainResults();
        });
        async function scanChainResults() {
            const contract = new ethers.Contract(gameAddress, gameABI, provider);
            const logs = await provider.getLogs({
                address: gameAddress,
                fromBlock: 0,
                toBlock: "latest",
                topics: [ethers.utils.id("GameResolved(uint256,address,uint256,uint256)")]
            });
            const results = logs
                .map((log) => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        const winner = parsed.args.winner.toLowerCase();
                        return {
                            gameId: parsed.args.gameId.toString(),
                            winner,
                            tokenId1: parsed.args.tokenId1.toString(),
                            tokenId2: parsed.args.tokenId2.toString()
                        };
                    } catch {
                        return null;
                    }
                })
                .filter(
                    (e) => e && account && e.winner === account.toLowerCase()
                );
            if (results.length === 0) {
                resultsList.innerHTML = `<p class="text-sm text-center">No resolved games found for your address.</p>`;
                return;
            }
            resultsList.innerHTML = "";
            results.forEach((res) => {
                const div = document.createElement("div");
                div.className = "border p-2 mb-2 rounded";
                div.innerHTML = `
                    <p class="text-xs font-bold">Game #${res.gameId}</p>
                    <p class="text-xs mb-1">NFT ${res.tokenId1} vs ${res.tokenId2}</p>
                    <button class="neon-button w-full play-result"
                            data-token1="${res.tokenId1}"
                            data-token2="${res.tokenId2}"
                            data-win="true">▶️ Resolve</button>
                `;
                resultsList.appendChild(div);
            });
            document.querySelectorAll(".play-result").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const image1 = `https://f005.backblazeb2.com/file/sketchymilios/${btn.dataset.token1}.png`;
                    const image2 = `https://f005.backblazeb2.com/file/sketchymilios/${btn.dataset.token2}.png`;
                    playResultVideo("/win.mp4", "You Win!", image1, image2);
                });
            });
        }
        function playResultVideo(src, text, image1, image2) {
            animationNFTs.innerHTML = `
                <img src="${image1}" alt="NFT1" class="w-16 h-16 mr-2 rounded border border-white">
                <img src="${image2}" alt="NFT2" class="w-16 h-16 rounded border border-white">
            `;
            resultText.textContent = text;
            resultVideo.src = src;
            videoOverlay.classList.remove("hidden");
            resultVideo.play();
            resultVideo.onended = () => {
                videoOverlay.classList.add("hidden");
                resultVideo.src = "";
                animationNFTs.innerHTML = "";
            };
        }
    </script>
</body>
</html>