<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Flips - Arcade Playground</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            background-image: url('/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
        }
        @media (max-width: 768px) {
            html, body {
                overflow-y: auto;
            }
        }
        .neon-button {
            background: linear-gradient(to right, #ffeb3b, #ff9800);
            color: black;
            font-weight: bold;
            border-radius: 1rem;
            padding: 0.3rem 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.8rem;
            border: 1px solid #ff9800;
        }
        .neon-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(255, 152, 0, 0.5), 0 0 15px rgba(255, 235, 59, 0.3);
        }
        .game-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #ff9800;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        .game-card:hover {
            transform: translateY(-3px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 40px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 10px;
            width: 90%;
            max-width: 400px;
            border-radius: 0.75rem;
            border: 1px solid #ff9800;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 20px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
        }
        .nft-item {
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease;
        }
        .nft-item:hover {
            transform: scale(1.05);
        }
        .nft-item img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid #ff9800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #videoOverlay {
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        #videoOverlay.fade-in {
            opacity: 1;
        }
        #videoOverlay.fade-out {
            opacity: 0;
        }
        .info-button {
            background-color: #ff9800;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            font-size: 0.6rem;
            border: 1px solid #fff;
        }
        .info-button:hover {
            transform: scale(1.1);
        }
        .status-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #loadingScreen.show {
            opacity: 1;
        }
        #loadingScreen.hide {
            opacity: 0;
            pointer-events: none;
        }
        #loadingText {
            color: #fff;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px #ff9800;
            animation: fadeText 1.5s infinite;
            border: 2px solid #ff9800;
            padding: 10px;
            border-radius: 0.5rem;
        }
        @keyframes fadeText {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="text-black">
    <!-- Header -->
    <header class="w-full text-center py-2 bg-gradient-to-r from-yellow-400 to-orange-500 shadow-sm">
        <h1 class="text-xl md:text-2xl font-extrabold text-white">üéÆ Sketchy Flips üé≤</h1>
        <p class="text-xs md:text-sm text-white">Fun, friends, NFTs!</p>
    </header>

    <!-- Main Menu -->
    <div id="mainMenu" class="w-full max-w-2xl p-2 flex flex-col items-center justify-center">
        <div class="flex flex-col sm:flex-row justify-center gap-2">
            <div class="relative">
                <button id="betButton" class="neon-button">Bet-A-Sketchy</button>
                <button id="infoButton" class="info-button absolute -top-1 -right-1">i</button>
            </div>
            <button class="neon-button opacity-50 cursor-not-allowed">Stake-A-Milio (Soon)</button>
        </div>
    </div>

    <!-- Game Interface -->
    <div id="gameInterface" class="hidden w-full max-w-4xl p-2 flex flex-col gap-2 h-[calc(100vh-80px)]">
        <!-- Controls -->
        <div class="w-full flex flex-col gap-2">
            <button id="connectWallet" class="neon-button">üîå Connect Wallet</button>
            <p id="accountInfo" class="game-card p-1 text-center text-xs">Account: Not connected</p>
            <div class="game-card p-2">
                <label class="block font-bold text-xs mb-1">Selected NFT:</label>
                <div id="selectedNFT" class="w-full p-1 rounded-lg border border-orange-500 bg-white text-center text-xs">Your Sketchy</div>
                <button id="selectNFTBtn" disabled class="neon-button w-full mt-1">üéØ Select NFT</button>
            </div>
            <button id="createGameBtn" disabled class="neon-button w-full">üé∞ Create Game</button>
            <div class="game-card p-2 flex-grow max-h-32">
                <h2 class="text-sm text-center mb-1 font-bold">üéØ Open Games</h2>
                <ul id="openGamesList" class="space-y-2 overflow-y-auto"></ul>
            </div>
            <div class="game-card p-2 flex-grow max-h-32">
                <h2 class="text-sm text-center mb-1 font-bold">‚è≥ Ongoing Games</h2>
                <ul id="ongoingGamesList" class="space-y-2 overflow-y-auto"></ul>
            </div>
            <div class="game-card p-2 flex-grow max-h-32">
                <h2 class="text-sm text-center mb-1 font-bold">üï∞ Timed Out Games</h2>
                <ul id="timedOutGamesList" class="space-y-2 overflow-y-auto"></ul>
            </div>
            <div class="game-card p-2 text-center text-xs font-bold status-pulse">Status: <span id="status">Waiting...</span></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg text-center mb-2 font-bold">About Bet-A-Sketchy</h2>
            <p class="text-center text-xs">50% chance PVP to win a Sketchy by betting one, verified by Gelato. 
                <a href="https://abscan.org/address/0xf6b8d2E0d36669Ed82059713BDc6ACfABe11Fde6#code" target="_blank" class="text-blue-500 hover:underline">ABScan</a> | 
                <a href="/moreinfo.html" target="_blank" class="text-blue-500 hover:underline">More Info</a>
            </p>
        </div>
    </div>

    <!-- NFT Selection Modal -->
    <div id="nftModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg text-center mb-2 font-bold">Select NFT</h2>
            <div id="nftGrid" class="nft-grid"></div>
        </div>
    </div>

    <!-- Video Overlay -->
    <div id="videoOverlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="relative">
            <video id="resultVideo" class="max-w-full max-h-64 rounded-lg border border-orange-500" autoplay></video>
            <div id="resultText" class="absolute inset-0 flex items-center justify-content-center text-white text-3xl font-bold" style="text-shadow: 1px 1px 3px black;"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="hide">
        <div id="loadingText">Loading SketchyMilios...</div>
    </div>

    <script>
        let provider, signer, account, gameContract, gameContractWithSigner, nftContract;
        const gameAddress = '0xf6b8d2E0d36669Ed82059713BDc6ACfABe11Fde6';
        const nftAddress = '0x08533a2b16e3db03eebd5b23210122f97dfcb97d';
        // Replace with your Render backend URL
        const socket = io('https://sketchyflipback.onrender.com', {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        const gameABI = [
            "function createGame(uint256 tokenId)",
            "function joinGame(uint256 gameId, uint256 tokenId)",
            "function getOpenGames() view returns (uint256[])",
            "function getGame(uint256 gameId) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "function cancelGame(uint256 gameId)",
            "function cancelUnjoinedGame(uint256 gameId)",
            "function games(uint256) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "event GameCreated(uint256 gameId, address player1, uint256 tokenId1)",
            "event GameJoined(uint256 gameId, address player2, uint256 tokenId2)",
            "event RandomnessRequested(uint256 gameId, uint256 requestId)",
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)",
            "event GameCanceled(uint256 gameId)"
        ];

        const nftABI = [
            "function tokensOfOwner(address owner) view returns (uint256[])",
            "function approve(address to, uint256 tokenId)",
            "function tokenURI(uint256 tokenId) view returns (string)"
        ];

        let selectedTokenId = null;
        let userTokens = [];

        // Modals and Loading Screen
        const infoModal = document.getElementById('infoModal');
        const nftModal = document.getElementById('nftModal');
        const loadingScreen = document.getElementById('loadingScreen');
        const infoClose = infoModal.querySelector('.close');
        const nftClose = nftModal.querySelector('.close');
        const nftGrid = document.getElementById('nftGrid');
        const selectNFTBtn = document.getElementById('selectNFTBtn');

        infoClose.onclick = () => { infoModal.style.display = 'none'; };
        nftClose.onclick = () => { nftModal.style.display = 'none'; };
        window.onclick = (event) => {
            if (event.target == infoModal) infoModal.style.display = 'none';
            if (event.target == nftModal) nftModal.style.display = 'none';
        };

        document.getElementById('infoButton').addEventListener('click', () => {
            infoModal.style.display = 'block';
        });

        document.getElementById('betButton').addEventListener('click', () => {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
        });

        selectNFTBtn.addEventListener('click', () => {
            console.log('Opening NFT selection modal');
            displayNFTsInModal();
            nftModal.style.display = 'block';
        });

        function showLoadingScreen() {
            console.log('Showing loading screen');
            loadingScreen.classList.remove('hide');
            loadingScreen.classList.add('show');
        }

        function hideLoadingScreen() {
            console.log('Hiding loading screen');
            loadingScreen.classList.remove('show');
            loadingScreen.classList.add('hide');
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function fetchUserTokens(showLoading = false) {
            if (!nftContract || !account) return;
            if (showLoading) showLoadingScreen();
            userTokens = [];
            nftGrid.innerHTML = '<p class="text-center text-xs">Loading NFTs...</p>';
            try {
                const tokens = await nftContract.tokensOfOwner(account);
                for (let id of tokens) {
                    let uri = await nftContract.tokenURI(id);
                    if (uri.startsWith('ipfs://')) uri = 'https://ipfs.io/ipfs/' + uri.slice(7);
                    const response = await fetch(uri);
                    const metadata = await response.json();
                    let image = metadata.image;
                    if (image.startsWith('ipfs://')) image = 'https://ipfs.io/ipfs/' + image.slice(7);
                    userTokens.push({ id: id.toString(), image });
                }
                selectNFTBtn.disabled = userTokens.length === 0;
                document.getElementById('createGameBtn').disabled = userTokens.length === 0;
                if (userTokens.length === 0) {
                    nftGrid.innerHTML = '<p class="text-center text-xs">No NFTs owned</p>';
                }
                if (showLoading) hideLoadingScreen();
            } catch (error) {
                console.error('Error fetching tokens:', error);
                updateStatus(`Tokens fetch error: ${error.message}`);
                nftGrid.innerHTML = '<p class="text-center text-red-500 text-xs">Error loading NFTs</p>';
                if (showLoading) hideLoadingScreen();
            }
        }

        function displayNFTsInModal() {
            console.log('Displaying NFTs in modal, count:', userTokens.length);
            nftGrid.innerHTML = '';
            userTokens.forEach(token => {
                console.log('Creating NFT item for token ID:', token.id);
                const div = document.createElement('div');
                div.className = 'nft-item';
                const img = document.createElement('img');
                img.src = token.image;
                img.alt = `NFT #${token.id}`;
                const p = document.createElement('p');
                p.className = 'text-xs';
                p.textContent = `#${token.id}`;
                div.appendChild(img);
                div.appendChild(p);
                div.addEventListener('click', () => {
                    console.log('NFT selected:', token.id);
                    selectNFT(token.id, token.image);
                });
                nftGrid.appendChild(div);
            });
        }

        function selectNFT(tokenId, image) {
            console.log('Selecting NFT with ID:', tokenId);
            selectedTokenId = tokenId;
            document.getElementById('selectedNFT').innerHTML = `<img src="${image}" alt="NFT #${tokenId}" class="w-8 h-8 inline-block mr-1 rounded border border-orange-500"><p class="inline text-xs">NFT #${tokenId}</p>`;
            nftModal.style.display = 'none';
        }

        function updateOpenGames(games) {
            const openGamesList = document.getElementById('openGamesList');
            if (!games || games.length === 0) {
                openGamesList.innerHTML = '<li class="text-center text-xs opacity-70">No open games.</li>';
                return;
            }
            let listHTML = '';
            const currentTime = Math.floor(Date.now() / 1000);
            games.forEach(game => {
                console.log('Rendering game:', game.id);
                const isMine = account && game.player1.toLowerCase() === account.toLowerCase();
                const canCancel = isMine && currentTime > Number(game.createTimestamp) + 3600;
                let actionButton = '';
                if (isMine) {
                    actionButton = canCancel 
                        ? `<button class="neon-button py-0.5 px-1 text-xs" onclick="cancelUnjoinedFromList(${game.id})">Cancel</button>`
                        : `<span class="text-xs opacity-70">Waiting...</span>`;
                } else if (account) {
                    actionButton = `<button class="neon-button py-0.5 px-1 text-xs" onclick="joinGameFromList(${game.id})">Join</button>`;
                } else {
                    actionButton = `<span class="text-xs opacity-70">Connect wallet to join</span>`;
                }
                listHTML += `
                    <li class="game-card p-2 flex justify-between items-center">
                        <div class="flex items-center">
                            <img src="${game.image}" alt="NFT #${game.tokenId1}" class="w-8 h-8 mr-2 rounded shadow border border-orange-500">
                            <div>
                                <span class="font-bold text-xs">Game #${game.id}</span><br>
                                <span class="text-xs opacity-70">NFT #${game.tokenId1} | ${game.createdAt}</span>
                            </div>
                        </div>
                        ${actionButton}
                    </li>`;
            });
            openGamesList.innerHTML = listHTML;
        }

        async function fetchOngoingGames() {
            if (!gameContract || !account) return;
            const ongoingGamesList = document.getElementById('ongoingGamesList');
            let listHTML = '';
            const currentTime = Math.floor(Date.now() / 1000);
            let foundAny = false;
            try {
                for (let i = 0; i < 1000; i++) {
                    try {
                        const game = await gameContract.getGame(i);
                        if (game.active && game.player2 !== '0x0000000000000000000000000000000000000000' &&
                            (game.player1.toLowerCase() === account.toLowerCase() || game.player2.toLowerCase() === account.toLowerCase())) {
                            foundAny = true;
                            let uri1 = await nftContract.tokenURI(game.tokenId1);
                            if (uri1.startsWith('ipfs://')) uri1 = 'https://ipfs.io/ipfs/' + uri1.slice(7);
                            const resp1 = await fetch(uri1);
                            const meta1 = await resp1.json();
                            let img1 = meta1.image;
                            if (img1.startsWith('ipfs://')) img1 = 'https://ipfs.io/ipfs/' + img1.slice(7);

                            let uri2 = await nftContract.tokenURI(game.tokenId2);
                            if (uri2.startsWith('ipfs://')) uri2 = 'https://ipfs.io/ipfs/' + uri2.slice(7);
                            const resp2 = await fetch(uri2);
                            const meta2 = await resp2.json();
                            let img2 = meta2.image;
                            if (img2.startsWith('ipfs://')) img2 = 'https://ipfs.io/ipfs/' + img2.slice(7);

                            const joinedAt = new Date(Number(game.joinTimestamp) * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                            const canCancel = currentTime > Number(game.joinTimestamp) + 86400;
                            let actionButton = canCancel ? `<button class="neon-button py-0.5 px-1 text-xs" onclick="cancelGameFromList(${i})">Cancel</button>` : '<span class="text-xs opacity-70">Waiting...</span>';
                            listHTML += `
                                <li class="game-card p-2 flex flex-col">
                                    <div class="font-bold text-xs">Game #${i}</div>
                                    <div class="flex gap-2 mt-1">
                                        <div><img src="${img1}" alt="NFT1" class="w-8 h-8 rounded shadow border border-orange-500"> <span class="text-xs">NFT #${game.tokenId1}</span></div>
                                        <div><img src="${img2}" alt="NFT2" class="w-8 h-8 rounded shadow border border-orange-500"> <span class="text-xs">NFT #${game.tokenId2}</span></div>
                                    </div>
                                    <div class="text-xs opacity-70 mt-1">${joinedAt}</div>
                                    ${actionButton}
                                </li>`;
                        }
                    } catch (e) {
                        if (e.message.includes('revert') || e.message.includes('out of bounds')) break;
                    }
                }
                ongoingGamesList.innerHTML = foundAny ? listHTML : '<li class="text-center text-xs opacity-70">No ongoing games.</li>';
            } catch (error) {
                console.error('Error fetching ongoing games:', error);
                updateStatus(`Error fetching games: ${error.message}`);
                ongoingGamesList.innerHTML = '<li class="text-center text-red-500 text-xs">Error loading</li>';
            }
        }

        async function fetchTimedOutGames() {
            if (!gameContract) return;
            const timedOutGamesList = document.getElementById('timedOutGamesList');
            let listHTML = '';
            const currentTime = Math.floor(Date.now() / 1000);
            let foundAny = false;
            try {
                for (let i = 0; i < 1000; i++) {
                    try {
                        const game = await gameContract.getGame(i);
                        const canCancel = game.active && game.player2 !== '0x0000000000000000000000000000000000000000' && currentTime > Number(game.joinTimestamp) + 86400;
                        if (canCancel) {
                            foundAny = true;
                            let uri1 = await nftContract.tokenURI(game.tokenId1);
                            if (uri1.startsWith('ipfs://')) uri1 = 'https://ipfs.io/ipfs/' + uri1.slice(7);
                            const resp1 = await fetch(uri1);
                            const meta1 = await resp1.json();
                            let img1 = meta1.image;
                            if (img1.startsWith('ipfs://')) img1 = 'https://ipfs.io/ipfs/' + img1.slice(7);

                            let uri2 = await nftContract.tokenURI(game.tokenId2);
                            if (uri2.startsWith('ipfs://')) uri2 = 'https://ipfs.io/ipfs/' + uri2.slice(7);
                            const resp2 = await fetch(uri2);
                            const meta2 = await resp2.json();
                            let img2 = meta2.image;
                            if (img2.startsWith('ipfs://')) img2 = 'https://ipfs.io/ipfs/' + img2.slice(7);

                            const joinedAt = new Date(Number(game.joinTimestamp) * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                            listHTML += `
                                <li class="game-card p-2 flex flex-col">
                                    <div class="font-bold text-xs">Game #${i}</div>
                                    <div class="flex gap-2 mt-1">
                                        <div><img src="${img1}" alt="NFT1" class="w-8 h-8 rounded shadow border border-orange-500"> <span class="text-xs">NFT #${game.tokenId1}</span></div>
                                        <div><img src="${img2}" alt="NFT2" class="w-8 h-8 rounded shadow border border-orange-500"> <span class="text-xs">NFT #${game.tokenId2}</span></div>
                                    </div>
                                    <div class="text-xs opacity-70 mt-1">${joinedAt}</div>
                                    <button class="neon-button py-0.5 px-1 text-xs mt-1" onclick="cancelGameFromList(${i})">Cancel</button>
                                </li>`;
                        }
                    } catch (e) {
                        if (e.message.includes('revert') || e.message.includes('out of bounds')) break;
                    }
                }
                timedOutGamesList.innerHTML = foundAny ? listHTML : '<li class="text-center text-xs opacity-70">No timed out games.</li>';
            } catch (error) {
                console.error('Error fetching timed out games:', error);
                updateStatus(`Error fetching games: ${error.message}`);
                timedOutGamesList.innerHTML = '<li class="text-center text-red-500 text-xs">Error loading</li>';
            }
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) {
                updateStatus('Install MetaMask.');
                return;
            }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('accountInfo').textContent = `Account: ${account.slice(0,6)}...${account.slice(-4)}`;
                updateStatus('Wallet connected...');
                
                gameContract = new ethers.Contract(gameAddress, gameABI, provider);
                gameContractWithSigner = gameContract.connect(signer);
                nftContract = new ethers.Contract(nftAddress, nftABI, signer);
                
                await fetchUserTokens(true); // Show loading screen only on connect
                updateStatus('Connected! Fetching games...');
                await fetchOngoingGames();
                await fetchTimedOutGames();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                updateStatus(`Connection error: ${error.message}`);
                if (error.code === -32603) {
                    updateStatus('RPC Error: Disconnect MetaMask from the website (click the globe icon in MetaMask) and reconnect.');
                }
            }
        });

        document.getElementById('createGameBtn').addEventListener('click', async () => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            if (!selectedTokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, selectedTokenId);
                await approveTx.wait();
                updateStatus('Creating game...');
                const tx = await gameContractWithSigner.createGame(selectedTokenId);
                await tx.wait();
                updateStatus('Game created! Waiting for join...');
                await fetchUserTokens(); // No loading screen
                selectedTokenId = null;
                document.getElementById('selectedNFT').innerHTML = 'Your Sketchy';
            } catch (error) {
                console.error('Error creating game:', error);
                updateStatus(`Error creating game: ${error.message}`);
                if (error.code === -32603) {
                    updateStatus('RPC Error: Disconnect MetaMask from the website (click the globe icon in MetaMask) and reconnect.');
                }
            }
        });

        window.joinGameFromList = async (gameId) => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            if (!selectedTokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, selectedTokenId);
                await approveTx.wait();
                updateStatus('Joining game...');
                const tx = await gameContractWithSigner.joinGame(gameId, selectedTokenId);
                await tx.wait();
                updateStatus('Joined! Waiting for result...');
                await fetchOngoingGames();
                await fetchTimedOutGames();
                await fetchUserTokens(); // No loading screen
                selectedTokenId = null;
                document.getElementById('selectedNFT').innerHTML = 'Your Sketchy';
            } catch (error) {
                console.error('Error joining game:', error);
                updateStatus(`Error joining: ${error.message}`);
                if (error.code === -32603) {
                    updateStatus('RPC Error: Disconnect MetaMask from the website (click the globe icon in MetaMask) and reconnect.');
                }
            }
        };

        window.cancelUnjoinedFromList = async (gameId) => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            try {
                updateStatus('Canceling game...');
                const tx = await gameContractWithSigner.cancelUnjoinedGame(gameId);
                await tx.wait();
                updateStatus('Game canceled.');
                await fetchUserTokens(); // No loading screen
            } catch (error) {
                console.error('Error canceling unjoined game:', error);
                updateStatus(`Error canceling: ${error.message}`);
                if (error.code === -32603) {
                    updateStatus('RPC Error: Disconnect MetaMask from the website (click the globe icon in MetaMask) and reconnect.');
                }
            }
        };

        window.cancelGameFromList = async (gameId) => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            try {
                updateStatus('Canceling game...');
                const tx = await gameContractWithSigner.cancelGame(gameId);
                await tx.wait();
                updateStatus('Game canceled.');
                await fetchOngoingGames();
                await fetchTimedOutGames();
                await fetchUserTokens(); // No loading screen
            } catch (error) {
                console.error('Error canceling game:', error);
                updateStatus(`Error canceling: ${error.message}`);
                if (error.code === -32603) {
                    updateStatus('RPC Error: Disconnect MetaMask from the website (click the globe icon in MetaMask) and reconnect.');
                }
            }
        };

        function playResultVideo(src, text) {
            console.log('Playing result video:', src, text);
            const video = document.getElementById('resultVideo');
            const overlay = document.getElementById('videoOverlay');
            const resultText = document.getElementById('resultText');

            video.src = src;
            resultText.textContent = text;

            overlay.classList.remove('hidden', 'fade-out');
            setTimeout(() => {
                overlay.classList.add('fade-in');
            }, 10);

            video.play();

            video.onended = () => {
                console.log('Video ended, hiding overlay');
                overlay.classList.remove('fade-in');
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('fade-out');
                }, 800);
            };
        }

        // Socket.IO event listeners
        socket.on('connect', () => {
            console.log('Connected to backend:', socket.id);
        });

        socket.on('openGamesUpdate', (games) => {
            console.log('Received open games update:', games);
            updateOpenGames(games);
        });

        socket.on('gameResolved', async (data) => {
            console.log('Received game resolved:', data);
            const win = account && data.winner.toLowerCase() === account.toLowerCase();
            updateStatus(`Game #${data.gameId} resolved: ${win ? 'You Win!' : 'You Lose!'}`);
            playResultVideo(win ? '/win.mp4' : '/lose.mp4', win ? 'You Win!' : 'You Lose!');
            await fetchOngoingGames();
            await fetchTimedOutGames();
            await fetchUserTokens();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from backend, attempting reconnect');
        });
    </script>
</body>
</html>