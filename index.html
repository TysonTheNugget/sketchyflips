<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Flips - Vegas Coin Flip Casino</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #000, #111);
            font-family: 'Arial Black', Arial, sans-serif;
        }
        .neon-text {
            text-shadow: 0 0 5px #ff0000, 0 0 10px #ff4500, 0 0 15px #ffff00;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes neon-glow {
            from { text-shadow: 0 0 5px #ff0000, 0 0 10px #ff4500, 0 0 15px #ffff00; }
            to { text-shadow: 0 0 10px #ff0000, 0 0 15px #ff4500, 0 0 20px #ffff00; }
        }
        .coin-container {
            perspective: 1000px;
            display: none; /* Hidden by default */
        }
        .coin {
            width: 150px;
            height: 150px;
            position: relative;
            transform-style: preserve-3d;
            animation: flip-coin 2s ease-in-out infinite;
        }
        .coin-front, .coin-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #000;
        }
        .coin-front {
            background: linear-gradient(to bottom, #ffd700, #ffa500);
            transform: rotateY(0deg);
        }
        .coin-back {
            background: linear-gradient(to bottom, #c0c0c0, #a9a9a9);
            transform: rotateY(180deg);
        }
        @keyframes flip-coin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        @media (max-width: 640px) {
            .coin {
                width: 100px;
                height: 100px;
                font-size: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .neon-text {
                text-shadow: 0 0 3px #ff0000, 0 0 6px #ff4500, 0 0 9px #ffff00;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="fixed inset-0 bg-[url('https://i.imgur.com/4z0vF0l.jpg')] bg-cover bg-center opacity-10"></div>
    <div class="relative w-full max-w-md mx-4 p-6 bg-gray-900 bg-opacity-90 rounded-lg shadow-lg shadow-red-500/50">
        <h1 class="text-3xl text-yellow-400 neon-text text-center mb-4">Sketchy Flips Casino!</h1>
        <div id="coinContainer" class="coin-container mx-auto mb-4">
            <div class="coin">
                <div class="coin-front">Heads</div>
                <div class="coin-back">Tails</div>
            </div>
        </div>
        <button id="connectWallet" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold py-2 px-4 rounded border-2 border-red-600 shadow-md shadow-yellow-500/50 hover:from-yellow-500 hover:to-orange-600 transition mb-4">Connect Wallet</button>
        <p id="accountInfo" class="text-center text-white text-lg mb-4">Account: Not connected</p>

        <label class="block text-yellow-400 mb-2">Select NFT to Bet:</label>
        <select id="tokenSelect" class="w-full bg-gray-800 text-white p-2 rounded mb-4">
            <option value="">Connect wallet first</option>
        </select>

        <button id="betBtn" disabled class="w-full bg-gradient-to-r from-green-500 to-green-700 text-white font-bold py-2 px-4 rounded border-2 border-red-600 shadow-md shadow-green-500/50 hover:from-green-600 hover:to-green-800 transition mb-4">Create Game (Bet NFT)</button>
        <p class="text-white text-center mb-4">To join, fetch open games and click Join.</p>

        <button id="fetchOpenGamesBtn" disabled class="w-full bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold py-2 px-4 rounded border-2 border-red-600 shadow-md shadow-blue-500/50 hover:from-blue-600 hover:to-blue-800 transition mb-4">Fetch Open Games</button>
        <ul id="openGamesList" class="mb-4"></ul>

        <div id="status" class="text-center text-white text-lg neon-text">Status: Ready to Flip!</div>
    </div>

    <script>
        let provider, signer, account, gameContract, gameContractWithSigner, nftContract;
        const gameAddress = '0x7c66a87014b387E7f33cE1B1F78e40e708E9F943';
        const nftAddress = '0x08533a2b16e3db03eebd5b23210122f97dfcb97d';

        const gameABI = [
            "function createGame(uint256 tokenId)",
            "function joinGame(uint256 gameId, uint256 tokenId)",
            "function getOpenGames() view returns (uint256[])",
            "function getGame(uint256 gameId) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "event GameCreated(uint256 gameId, address player1, uint256 tokenId1)",
            "event GameJoined(uint256 gameId, address player2, uint256 tokenId2)",
            "event RandomnessRequested(uint256 gameId, uint256 requestId)",
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)",
            "event GameCanceled(uint256 gameId)"
        ];

        const nftABI = [
            "function tokensOfOwner(address owner) view returns (uint256[])",
            "function approve(address to, uint256 tokenId)"
        ];

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) return updateStatus('Install MetaMask.');
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('accountInfo').textContent = `Account: ${account.slice(0,6)}...${account.slice(-4)}`;
                updateStatus('Wallet connected. Initializing contracts...');
                
                gameContract = new ethers.Contract(gameAddress, gameABI, provider);
                gameContractWithSigner = gameContract.connect(signer);
                nftContract = new ethers.Contract(nftAddress, nftABI, signer);
                
                await fetchUserTokens();
                document.getElementById('betBtn').disabled = false;
                document.getElementById('fetchOpenGamesBtn').disabled = false;
                updateStatus('Ready to Flip!');
                setupEventListeners();
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
            }
        });

        async function fetchUserTokens() {
            if (!nftContract || !account) return;
            const tokenSelect = document.getElementById('tokenSelect');
            tokenSelect.innerHTML = '<option value="">Loading...</option>';
            try {
                const tokens = await nftContract.tokensOfOwner(account);
                tokenSelect.innerHTML = tokens.length > 0
                    ? tokens.map(id => `<option value="${id.toString()}">${id.toString()}</option>`).join('')
                    : '<option value="">No NFTs owned</option>';
            } catch (error) {
                updateStatus(`Tokens fetch error: ${error.message}`);
                tokenSelect.innerHTML = '<option value="">Error loading tokens</option>';
            }
        }

        document.getElementById('betBtn').addEventListener('click', async () => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            const tokenId = document.getElementById('tokenSelect').value;
            if (!tokenId) return updateStatus('Select a token to bet.');
            try {
                updateStatus('Approving NFT for transfer...');
                const approveTx = await nftContract.approve(gameAddress, tokenId);
                await approveTx.wait();
                updateStatus('Approval confirmed.');

                const tx = await gameContractWithSigner.createGame(tokenId);
                let message = `Created game with token ${tokenId}. TX: ${tx.hash}`;
                const receipt = await tx.wait();
                const gameCreatedEvent = receipt.events.find(e => e.event === 'GameCreated');
                const newGameId = gameCreatedEvent ? gameCreatedEvent.args.gameId.toString() : 'unknown';
                message += ` Game ID: ${newGameId} (use this to join)`;
                updateStatus(`${message} - Transaction confirmed! Waiting for someone to join...`);
                document.getElementById('fetchOpenGamesBtn').click();
            } catch (error) {
                updateStatus(`Error creating game: ${error.message}`);
            }
        });

        async function joinGameFromList(gameId) {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            const tokenId = document.getElementById('tokenSelect').value;
            if (!tokenId) return updateStatus('Select a token to bet.');
            try {
                updateStatus('Approving NFT for transfer...');
                const approveTx = await nftContract.approve(gameAddress, tokenId);
                await approveTx.wait();
                updateStatus('Approval confirmed.');

                const tx = await gameContractWithSigner.joinGame(gameId, tokenId);
                const message = `Joined game ${gameId} with token ${tokenId}. TX: ${tx.hash}`;
                await tx.wait();
                updateStatus(`${message} - Transaction confirmed! Flipping coin...`);
                document.getElementById('coinContainer').style.display = 'block';
            } catch (error) {
                updateStatus(`Error joining game: ${error.message}`);
            }
        }

        document.getElementById('fetchOpenGamesBtn').addEventListener('click', async () => {
            if (!gameContract) return updateStatus('Connect wallet first.');
            const openGamesList = document.getElementById('openGamesList');
            openGamesList.innerHTML = '<li class="text-white">Loading...</li>';
            try {
                const openIds = await gameContract.getOpenGames();
                if (openIds.length === 0) {
                    openGamesList.innerHTML = '<li class="text-white">No open games found.</li>';
                    return;
                }
                let listHTML = '';
                for (let id of openIds) {
                    const game = await gameContract.getGame(id);
                    listHTML += `<li class="text-white">Game ID: ${id} | Player1: ${game.player1.slice(0,6)}...${game.player1.slice(-4)} | Token: ${game.tokenId1} | Created: ${new Date(game.createTimestamp * 1000).toLocaleString()} <button class="bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold py-1 px-2 rounded border-2 border-red-600 text-sm" onclick="joinGameFromList(${id})">Join</button></li>`;
                }
                openGamesList.innerHTML = listHTML;
            } catch (error) {
                updateStatus(`Error fetching games: ${error.message}`);
                openGamesList.innerHTML = '<li class="text-white">Error loading games</li>';
            }
        });

        function setupEventListeners() {
            gameContract.on('GameCreated', (gameId, player1, tokenId1) => {
                updateStatus(`New game created! ID: ${gameId} by ${player1.slice(0,6)}... with token ${tokenId1}`);
                document.getElementById('fetchOpenGamesBtn').click();
            });
            gameContract.on('GameJoined', (gameId, player2, tokenId2) => {
                updateStatus(`Game ${gameId} joined by ${player2.slice(0,6)}... with token ${tokenId2}. Flipping coin...`);
                document.getElementById('coinContainer').style.display = 'block';
            });
            gameContract.on('RandomnessRequested', (gameId, requestId) => {
                updateStatus(`Flip requested for game ${gameId} (Request ID: ${requestId}). Waiting for Gelato...`);
            });
            gameContract.on('GameResolved', (gameId, winner, tokenId1, tokenId2) => {
                updateStatus(`Game ${gameId} resolved! Winner: ${winner.slice(0,6)}... gets tokens ${tokenId1} & ${tokenId2}`);
                document.getElementById('coinContainer').style.display = 'none';
                document.getElementById('fetchOpenGamesBtn').click();
            });
            gameContract.on('GameCanceled', (gameId) => {
                updateStatus(`Game ${gameId} canceled. NFTs returned.`);
                document.getElementById('fetchOpenGamesBtn').click();
            });
        }
    </script>
</body>
</html>