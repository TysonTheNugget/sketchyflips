<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Flips - Las Vegas Coin Flip Casino</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #000, #111);
            color: gold;
            font-family: 'Arial Black', sans-serif;
            text-align: center;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .casino-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://i.imgur.com/4z0vF0l.jpg') no-repeat center center/cover; /* Las Vegas night background */
            opacity: 0.3;
            z-index: -1;
        }
        h1 {
            font-size: 3em;
            text-shadow: 0 0 10px red, 0 0 20px orange, 0 0 30px yellow;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes neon-glow {
            from { text-shadow: 0 0 10px red, 0 0 20px orange, 0 0 30px yellow; }
            to { text-shadow: 0 0 20px red, 0 0 30px orange, 0 0 40px yellow; }
        }
        .lights {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .light {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: flash 1s infinite alternate;
        }
        .light1 { top: 10%; left: 10%; background: red; animation-delay: 0s; }
        .light2 { top: 20%; left: 80%; background: yellow; animation-delay: 0.2s; }
        .light3 { top: 30%; left: 50%; background: green; animation-delay: 0.4s; }
        .light4 { top: 40%; left: 20%; background: blue; animation-delay: 0.6s; }
        .light5 { top: 50%; left: 70%; background: purple; animation-delay: 0.8s; }
        .light6 { top: 60%; left: 30%; background: orange; animation-delay: 1s; }
        .light7 { top: 70%; left: 60%; background: pink; animation-delay: 1.2s; }
        .light8 { top: 80%; left: 40%; background: cyan; animation-delay: 1.4s; }
        .light9 { top: 15%; left: 60%; background: white; animation-delay: 0.1s; }
        .light10 { top: 25%; left: 40%; background: magenta; animation-delay: 0.3s; }
        .light11 { top: 35%; left: 70%; background: lime; animation-delay: 0.5s; }
        .light12 { top: 45%; left: 30%; background: turquoise; animation-delay: 0.7s; }
        .light13 { top: 55%; left: 80%; background: violet; animation-delay: 0.9s; }
        .light14 { top: 65%; left: 10%; background: indigo; animation-delay: 1.1s; }
        .light15 { top: 75%; left: 50%; background: gold; animation-delay: 1.3s; }
        @keyframes flash {
            0% { opacity: 0.5; box-shadow: 0 0 10px currentColor; }
            100% { opacity: 1; box-shadow: 0 0 30px currentColor; }
        }
        .coin-container {
            margin: 20px;
            perspective: 1000px;
        }
        .coin {
            width: 100px;
            height: 100px;
            position: relative;
            transform-style: preserve-3d;
            animation: flip-coin 2s ease-in-out infinite;
        }
        .coin-front, .coin-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: black;
        }
        .coin-front { background: gold; transform: rotateY(0deg); }
        .coin-back { background: silver; transform: rotateY(180deg); }
        @keyframes flip-coin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        button {
            background: linear-gradient(gold, orange);
            border: 2px solid red;
            color: black;
            padding: 10px 20px;
            font-size: 1.5em;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 0 10px yellow;
            animation: button-glow 1s infinite alternate;
        }
        @keyframes button-glow {
            from { box-shadow: 0 0 10px yellow; }
            to { box-shadow: 0 0 20px red; }
        }
        input, select {
            padding: 10px;
            margin: 10px;
            font-size: 1.2em;
        }
        .status {
            font-size: 1.5em;
            color: white;
            text-shadow: 0 0 5px red;
        }
        ul { list-style-type: none; padding: 0; }
        li { margin: 5px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="casino-bg"></div>
    <div class="lights">
        <div class="light light1"></div>
        <div class="light light2"></div>
        <div class="light light3"></div>
        <div class="light light4"></div>
        <div class="light light5"></div>
        <div class="light light6"></div>
        <div class="light light7"></div>
        <div class="light light8"></div>
        <div class="light light9"></div>
        <div class="light light10"></div>
        <div class="light light11"></div>
        <div class="light light12"></div>
        <div class="light light13"></div>
        <div class="light light14"></div>
        <div class="light light15"></div>
    </div>
    <h1>Sketchy Flips - Vegas Coin Flip Casino!</h1>
    <div class="coin-container">
        <div class="coin">
            <div class="coin-front">Heads</div>
            <div class="coin-back">Tails</div>
        </div>
    </div>
    <button id="connectWallet">Connect Wallet</button>
    <p id="accountInfo" class="status">Account: Not connected</p>

    <label>Select NFT to Bet: <select id="tokenSelect"><option value="">Connect wallet first</option></select></label><br>
    <label>Game ID (to join): <input id="gameId" type="number" placeholder="Leave blank to create"></label><br>
    <button id="betBtn" disabled>Bet NFT</button>

    <button id="fetchOpenGamesBtn" disabled>Fetch Open Games</button>
    <ul id="openGamesList"></ul>

    <div class="status" id="status">Status: Ready to Flip!</div>

    <script>
        let provider, signer, account, gameContract, gameContractWithSigner, nftContract;
        const gameAddress = '0x7c66a87014b387E7f33cE1B1F78e40e708E9F943'; // Update to new if redeployed
        const nftAddress = '0x08533a2b16e3db03eebd5b23210122f97dfcb97d';

        const gameABI = [
            "function createGame(uint256 tokenId)",
            "function joinGame(uint256 gameId, uint256 tokenId)",
            "function getOpenGames() view returns (uint256[])",
            "function getGame(uint256 gameId) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "event GameCreated(uint256 gameId, address player1, uint256 tokenId1)",
            "event GameJoined(uint256 gameId, address player2, uint256 tokenId2)",
            "event RandomnessRequested(uint256 gameId, uint256 requestId)",
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)",
            "event GameCanceled(uint256 gameId)"
        ];

        const nftABI = [
            "function tokensOfOwner(address owner) view returns (uint256[])",
            "function approve(address to, uint256 tokenId)"
        ];

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) return updateStatus('Install MetaMask.');
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('accountInfo').textContent = `Account: ${account}`;
                updateStatus('Wallet connected. Initializing contracts...');
                
                gameContract = new ethers.Contract(gameAddress, gameABI, provider);
                gameContractWithSigner = gameContract.connect(signer);
                nftContract = new ethers.Contract(nftAddress, nftABI, signer);
                
                await fetchUserTokens();
                document.getElementById('betBtn').disabled = false;
                document.getElementById('fetchOpenGamesBtn').disabled = false;
                updateStatus('Ready to Flip!');
                setupEventListeners();
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
            }
        });

        async function fetchUserTokens() {
            if (!nftContract || !account) return;
            const tokenSelect = document.getElementById('tokenSelect');
            tokenSelect.innerHTML = '<option value="">Loading...</option>';
            try {
                const tokens = await nftContract.tokensOfOwner(account);
                tokenSelect.innerHTML = tokens.length > 0
                    ? tokens.map(id => `<option value="${id.toString()}">${id.toString()}</option>`).join('')
                    : '<option value="">No NFTs owned</option>';
            } catch (error) {
                updateStatus(`Tokens fetch error: ${error.message}`);
                tokenSelect.innerHTML = '<option value="">Error loading tokens</option>';
            }
        }

        document.getElementById('betBtn').addEventListener('click', async () => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            const tokenId = document.getElementById('tokenSelect').value;
            const gameId = document.getElementById('gameId').value;
            if (!tokenId) return updateStatus('Select a token to bet.');
            try {
                // Approve the token for the game contract
                updateStatus('Approving NFT for transfer...');
                const approveTx = await nftContract.approve(gameAddress, tokenId);
                await approveTx.wait();
                updateStatus('Approval confirmed.');

                let tx, message;
                if (gameId === '') {
                    tx = await gameContractWithSigner.createGame(tokenId);
                    message = `Created game with token ${tokenId}. TX: ${tx.hash}`;
                    // Wait for tx to mine, then get gameId from event or assume length-1
                    const receipt = await tx.wait();
                    const gameCreatedEvent = receipt.events.find(e => e.event === 'GameCreated');
                    const newGameId = gameCreatedEvent ? gameCreatedEvent.args.gameId.toString() : 'unknown';
                    message += ` Game ID: ${newGameId} (use this to join)`;
                } else {
                    tx = await gameContractWithSigner.joinGame(gameId, tokenId);
                    message = `Joined game ${gameId} with token ${tokenId}. TX: ${tx.hash}`;
                }
                await tx.wait();
                updateStatus(`${message} - Transaction confirmed! Waiting for flip result...`);
            } catch (error) {
                updateStatus(`Error betting: ${error.message}`);
            }
        });

        document.getElementById('fetchOpenGamesBtn').addEventListener('click', async () => {
            if (!gameContract) return updateStatus('Connect wallet first.');
            const openGamesList = document.getElementById('openGamesList');
            openGamesList.innerHTML = '<li>Loading...</li>';
            try {
                const openIds = await gameContract.getOpenGames();
                if (openIds.length === 0) {
                    openGamesList.innerHTML = '<li>No open games found.</li>';
                    return;
                }
                let listHTML = '';
                for (let id of openIds) {
                    const game = await gameContract.getGame(id);
                    listHTML += `<li>Game ID: ${id} | Player1: ${game.player1.slice(0,6)}...${game.player1.slice(-4)} | Token: ${game.tokenId1} | Created: ${new Date(game.createTimestamp * 1000).toLocaleString()}</li>`;
                }
                openGamesList.innerHTML = listHTML;
            } catch (error) {
                updateStatus(`Error fetching games: ${error.message}`);
                openGamesList.innerHTML = '<li>Error loading games</li>';
            }
        });

        function setupEventListeners() {
            gameContract.on('GameCreated', (gameId, player1, tokenId1) => {
                updateStatus(`New game created! ID: ${gameId} by ${player1.slice(0,6)}... with token ${tokenId1}`);
            });
            gameContract.on('GameJoined', (gameId, player2, tokenId2) => {
                updateStatus(`Game ${gameId} joined by ${player2.slice(0,6)}... with token ${tokenId2}. Requesting flip...`);
            });
            gameContract.on('RandomnessRequested', (gameId, requestId) => {
                updateStatus(`Flip requested for game ${gameId} (Request ID: ${requestId}). Waiting for Gelato...`);
            });
            gameContract.on('GameResolved', (gameId, winner, tokenId1, tokenId2) => {
                updateStatus(`Game ${gameId} resolved! Winner: ${winner.slice(0,6)}... gets tokens ${tokenId1} & ${tokenId2}`);
            });
            gameContract.on('GameCanceled', (gameId) => {
                updateStatus(`Game ${gameId} canceled. NFTs returned.`);
            });
        }
    </script>
</body>
</html>