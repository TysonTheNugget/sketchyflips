<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Flips - Arcade Playground</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('public/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        .arcade-bg {
            background-color: #fdd835; /* bright yellow for arcade front */
            color: #d32f2f; /* arcade red */
        }
        .ferris-bg {
            background-color: #ba68c8; /* ferris wheel pink */
        }
        .game-card {
            background: linear-gradient(to bottom right, #f06292, #9575cd); /* playful pink/purple */
            border: 2px solid #7e57c2;
            box-shadow: 0 0 10px #f06292;
        }
        .neon-button {
            background: linear-gradient(to right, #ffeb3b, #ff9800);
            color: black;
            font-weight: bold;
            border-radius: 12px;
            padding: 12px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .neon-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #ff9800, 0 0 20px #ffeb3b;
        }
        .coin-container {
            perspective: 1000px;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }
        .coin {
            width: 150px;
            height: 150px;
            position: relative;
            transform-style: preserve-3d;
            animation: flip-coin 2s ease-in-out;
        }
        .coin-front, .coin-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #000;
        }
        .coin-front {
            background: linear-gradient(to bottom, #ffd700, #ffa500);
            transform: rotateY(0deg);
        }
        .coin-back {
            background: linear-gradient(to bottom, #c0c0c0, #a9a9a9);
            transform: rotateY(180deg);
        }
        @keyframes flip-coin {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(1980deg); } /* Multiple flips for realism */
            100% { transform: rotateY(3600deg); } /* Ends on a full rotation */
        }
        @media (max-width: 640px) {
            .coin {
                width: 100px;
                height: 100px;
                font-size: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        /* Enhanced styles for professional look */
        .game-list-item {
            transition: all 0.3s ease;
        }
        .game-list-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #ff9800;
        }
        .status-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 12px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .nft-item {
            cursor: pointer;
            text-align: center;
        }
        .nft-item img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid #7e57c2;
        }
        .nft-item:hover img {
            box-shadow: 0 0 10px #f06292;
        }
        /* Video overlay styles */
        #videoOverlay {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #videoOverlay.fade-in {
            opacity: 1;
        }
        #videoOverlay.fade-out {
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start text-black">
    <!-- Header -->
    <header class="w-full text-center py-6 arcade-bg shadow-lg">
        <h1 class="text-4xl font-extrabold">ðŸŽ® Sketchy Flips Arcade ðŸŽ²</h1>
        <p class="text-lg">Fun, friends, and flipping NFTs!</p>
    </header>

    <!-- Main content -->
    <main class="w-full max-w-6xl p-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Coin Animation -->
        <div id="coinContainer" class="coin-container flex items-center justify-center game-card rounded-lg p-4">
            <div class="coin mx-auto">
                <div class="coin-front">Heads</div>
                <div class="coin-back">Tails</div>
            </div>
        </div>

        <!-- Wallet + Bet -->
        <div class="game-card rounded-lg p-4">
            <button id="connectWallet" class="neon-button w-full mb-4">ðŸ”Œ Connect Wallet</button>
            <p id="accountInfo" class="text-center text-sm">Account: Not connected</p>
            <label class="block mt-4">Selected NFT:</label>
            <div id="selectedNFT" class="w-full mt-1 p-2 rounded-lg border border-gray-400 bg-white text-center">None selected</div>
            <button id="selectNFTBtn" disabled class="neon-button w-full mt-2">ðŸŽ¨ Select NFT</button>
            <button id="betBtn" disabled class="neon-button w-full mt-4">ðŸŽ° Create Flip Game</button>
        </div>

        <!-- Live Lobby -->
        <div class="col-span-2 game-card rounded-lg p-4">
            <h2 class="text-2xl text-center mb-2">ðŸŽ¯ Live Flip Lobby</h2>
            <ul id="openGamesList" class="max-h-64 overflow-y-auto space-y-3"></ul>
        </div>

        <!-- Status -->
        <div class="col-span-2 text-center text-lg font-bold status-pulse">Status: <span id="status">Waiting for connection...</span></div>
    </main>

    <!-- NFT Selection Modal -->
    <div id="nftModal" class="modal">
        <div class="modal-content">
            <span class="close">Ã—</span>
            <h2 class="text-2xl text-center mb-4">Select Your Sketchy NFT</h2>
            <div id="nftGrid" class="nft-grid"></div>
        </div>
    </div>

    <!-- Video Overlay -->
    <div id="videoOverlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="relative">
            <video id="resultVideo" class="max-w-full max-h-full" autoplay></video>
            <div id="resultText" class="absolute inset-0 flex items-center justify-center text-white text-6xl font-bold" style="text-shadow: 2px 2px 4px black;"></div>
        </div>
    </div>

    <script>
        let provider, signer, account, gameContract, gameContractWithSigner, nftContract;
        const gameAddress = '0xf6b8d2E0d36669Ed82059713BDc6ACfABe11Fde6';
        const nftAddress = '0x08533a2b16e3db03eebd5b23210122f97dfcb97d';

        const gameABI = [
            "function createGame(uint256 tokenId)",
            "function joinGame(uint256 gameId, uint256 tokenId)",
            "function getOpenGames() view returns (uint256[])",
            "function getGame(uint256 gameId) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "event GameCreated(uint256 gameId, address player1, uint256 tokenId1)",
            "event GameJoined(uint256 gameId, address player2, uint256 tokenId2)",
            "event RandomnessRequested(uint256 gameId, uint256 requestId)",
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)",
            "event GameCanceled(uint256 gameId)"
        ];

        const nftABI = [
            "function tokensOfOwner(address owner) view returns (uint256[])",
            "function approve(address to, uint256 tokenId)",
            "function tokenURI(uint256 tokenId) view returns (string)"
        ];

        let refreshInterval;
        let selectedTokenId = null;
        let userTokens = []; // To store tokenIds and their images

        const modal = document.getElementById('nftModal');
        const closeBtn = document.getElementsByClassName('close')[0];
        const nftGrid = document.getElementById('nftGrid');
        const selectNFTBtn = document.getElementById('selectNFTBtn');

        closeBtn.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };

        selectNFTBtn.addEventListener('click', () => {
            displayNFTsInModal();
            modal.style.display = 'block';
        });

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function fetchUserTokens() {
            if (!nftContract || !account) return;
            userTokens = [];
            nftGrid.innerHTML = '<p class="text-center">Loading NFTs...</p>';
            try {
                const tokens = await nftContract.tokensOfOwner(account);
                for (let id of tokens) {
                    let uri = await nftContract.tokenURI(id);
                    if (uri.startsWith('ipfs://')) {
                        uri = 'https://ipfs.io/ipfs/' + uri.slice(7);
                    }
                    const response = await fetch(uri);
                    const metadata = await response.json();
                    let image = metadata.image;
                    if (image.startsWith('ipfs://')) {
                        image = 'https://ipfs.io/ipfs/' + image.slice(7);
                    }
                    userTokens.push({ id: id.toString(), image });
                }
                selectNFTBtn.disabled = userTokens.length === 0;
                if (userTokens.length === 0) {
                    nftGrid.innerHTML = '<p class="text-center">No NFTs owned</p>';
                }
            } catch (error) {
                updateStatus(`Tokens fetch error: ${error.message}`);
                nftGrid.innerHTML = '<p class="text-center text-red-500">Error loading NFTs</p>';
            }
        }

        function displayNFTsInModal() {
            nftGrid.innerHTML = '';
            userTokens.forEach(token => {
                const div = document.createElement('div');
                div.className = 'nft-item';
                div.innerHTML = `<img src="${token.image}" alt="NFT #${token.id}"><p>#${token.id}</p>`;
                div.onclick = () => selectNFT(token.id, token.image);
                nftGrid.appendChild(div);
            });
        }

        function selectNFT(tokenId, image) {
            selectedTokenId = tokenId;
            document.getElementById('selectedNFT').innerHTML = `<img src="${image}" alt="NFT #${tokenId}" class="w-16 h-16 inline-block mr-2">NFT #${tokenId}`;
            modal.style.display = 'none';
        }

        async function fetchOpenGames() {
            if (!gameContract) return;
            const openGamesList = document.getElementById('openGamesList');
            openGamesList.innerHTML = '<li class="text-center opacity-80">Loading live games...</li>';
            try {
                const openIds = await gameContract.getOpenGames();
                if (openIds.length === 0) {
                    openGamesList.innerHTML = '<li class="text-center opacity-80">No open games. Create one!</li>';
                    return;
                }
                let listHTML = '';
                for (let id of openIds) {
                    const game = await gameContract.getGame(id);
                    let uri = await nftContract.tokenURI(game.tokenId1);
                    if (uri.startsWith('ipfs://')) {
                        uri = 'https://ipfs.io/ipfs/' + uri.slice(7);
                    }
                    const response = await fetch(uri);
                    const metadata = await response.json();
                    let image = metadata.image;
                    if (image.startsWith('ipfs://')) {
                        image = 'https://ipfs.io/ipfs/' + image.slice(7);
                    }
                    const createdAt = new Date(game.createTimestamp * 1000).toLocaleTimeString();
                    listHTML += `
                        <li class="game-list-item bg-white bg-opacity-50 p-3 rounded-lg flex justify-between items-center border border-gray-600 hover:border-yellow-500 transition-all duration-300">
                            <div class="flex items-center">
                                <img src="${image}" alt="NFT #${game.tokenId1}" class="w-12 h-12 mr-4 rounded">
                                <div>
                                    <span class="font-bold">Game #${id}</span> | Player: ${game.player1.slice(0,6)}...${game.player1.slice(-4)}<br>
                                    <span class="text-sm opacity-80">Bet: NFT #${game.tokenId1} | Created: ${createdAt}</span>
                                </div>
                            </div>
                            <button class="neon-button py-2 px-4" onclick="joinGameFromList(${id})">Join</button>
                        </li>`;
                }
                openGamesList.innerHTML = listHTML;
            } catch (error) {
                updateStatus(`Error fetching games: ${error.message}`);
                openGamesList.innerHTML = '<li class="text-center text-red-500">Error loading games</li>';
            }
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) return updateStatus('Install MetaMask.');
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('accountInfo').textContent = `Account: ${account.slice(0,6)}...${account.slice(-4)}`;
                updateStatus('Wallet connected. Loading contracts...');
                
                gameContract = new ethers.Contract(gameAddress, gameABI, provider);
                gameContractWithSigner = gameContract.connect(signer);
                nftContract = new ethers.Contract(nftAddress, nftABI, signer);
                
                await fetchUserTokens();
                document.getElementById('betBtn').disabled = false;
                updateStatus('Connected! Fetching live games...');
                await fetchOpenGames();
                setupEventListeners();
                
                // Auto-refresh open games every 10 seconds for live feel
                refreshInterval = setInterval(fetchOpenGames, 10000);
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
            }
        });

        document.getElementById('betBtn').addEventListener('click', async () => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            if (!selectedTokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, selectedTokenId);
                await approveTx.wait();
                updateStatus('Approval done. Creating game...');

                const tx = await gameContractWithSigner.createGame(selectedTokenId);
                await tx.wait();
                updateStatus('Game created! Waiting for join...');
                fetchOpenGames(); // Immediate refresh
                fetchUserTokens(); // Update NFTs after bet
                selectedTokenId = null;
                document.getElementById('selectedNFT').innerHTML = 'None selected';
            } catch (error) {
                updateStatus(`Error creating game: ${error.message}`);
            }
        });

        window.joinGameFromList = async (gameId) => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            if (!selectedTokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, selectedTokenId);
                await approveTx.wait();
                updateStatus('Approval done. Joining game...');

                const tx = await gameContractWithSigner.joinGame(gameId, selectedTokenId);
                await tx.wait();
                updateStatus('Joined! Flipping coin...');
                document.getElementById('coinContainer').style.display = 'flex';
                const coin = document.querySelector('.coin');
                coin.style.animation = 'none'; // Reset animation
                setTimeout(() => { coin.style.animation = 'flip-coin 3s ease-in-out'; }, 10); // Trigger flip
                fetchOpenGames(); // Refresh list
                fetchUserTokens(); // Update NFTs
                selectedTokenId = null;
                document.getElementById('selectedNFT').innerHTML = 'None selected';
            } catch (error) {
                updateStatus(`Error joining: ${error.message}`);
            }
        };

        function playResultVideo(src, text) {
            const video = document.getElementById('resultVideo');
            const overlay = document.getElementById('videoOverlay');
            const resultText = document.getElementById('resultText');

            video.src = src;
            resultText.textContent = text;

            overlay.classList.remove('hidden', 'fade-out');
            setTimeout(() => {
                overlay.classList.add('fade-in');
            }, 10);

            video.play();

            video.onended = () => {
                overlay.classList.remove('fade-in');
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('fade-out');
                }, 1000); // Match transition duration
            };
        }

        function setupEventListeners() {
            gameContract.on('GameCreated', (gameId, player1, tokenId1) => {
                updateStatus(`New game #${gameId} created by ${player1.slice(0,6)}...`);
                fetchOpenGames();
            });
            gameContract.on('GameJoined', (gameId, player2, tokenId2) => {
                updateStatus(`Game #${gameId} joined by ${player2.slice(0,6)}... Flipping...`);
                document.getElementById('coinContainer').style.display = 'flex';
                const coin = document.querySelector('.coin');
                coin.style.animation = 'none';
                setTimeout(() => { coin.style.animation = 'flip-coin 3s ease-in-out'; }, 10);
                fetchOpenGames();
            });
            gameContract.on('RandomnessRequested', (gameId, requestId) => {
                updateStatus(`Flip in progress for #${gameId}...`);
            });
            gameContract.on('GameResolved', (gameId, winner, tokenId1, tokenId2) => {
                const win = winner.toLowerCase() === account.toLowerCase();
                updateStatus(`Game #${gameId} won by ${winner.slice(0,6)}...!`);
                document.getElementById('coinContainer').style.display = 'none';
                playResultVideo(win ? 'public/win.mp4' : 'public/lose.mp4', win ? 'You Win!' : 'You Lose!');
                fetchOpenGames();
                fetchUserTokens();
            });
            gameContract.on('GameCanceled', (gameId) => {
                updateStatus(`Game #${gameId} canceled.`);
                fetchOpenGames();
                fetchUserTokens();
            });
        }

        // Stop interval on disconnect or page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>