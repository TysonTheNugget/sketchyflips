<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchy Flips - Vegas Coin Flip Casino</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #000, #111);
            font-family: 'Arial Black', Arial, sans-serif;
        }
        .neon-text {
            text-shadow: 0 0 5px #ff0000, 0 0 10px #ff4500, 0 0 15px #ffff00;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes neon-glow {
            from { text-shadow: 0 0 5px #ff0000, 0 0 10px #ff4500, 0 0 15px #ffff00; }
            to { text-shadow: 0 0 10px #ff0000, 0 0 15px #ff4500, 0 0 20px #ffff00; }
        }
        .coin-container {
            perspective: 1000px;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }
        .coin {
            width: 150px;
            height: 150px;
            position: relative;
            transform-style: preserve-3d;
            animation: flip-coin 2s ease-in-out;
        }
        .coin-front, .coin-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #000;
        }
        .coin-front {
            background: linear-gradient(to bottom, #ffd700, #ffa500);
            transform: rotateY(0deg);
        }
        .coin-back {
            background: linear-gradient(to bottom, #c0c0c0, #a9a9a9);
            transform: rotateY(180deg);
        }
        @keyframes flip-coin {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(1980deg); } /* Multiple flips for realism */
            100% { transform: rotateY(3600deg); } /* Ends on a full rotation */
        }
        @media (max-width: 640px) {
            .coin {
                width: 100px;
                height: 100px;
                font-size: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .neon-text {
                text-shadow: 0 0 3px #ff0000, 0 0 6px #ff4500, 0 0 9px #ffff00;
            }
        }
        /* Enhanced styles for professional look */
        .game-list-item {
            transition: all 0.3s ease;
        }
        .game-list-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #ff4500;
        }
        .status-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center text-white">
    <div class="fixed inset-0 bg-[url('https://i.imgur.com/4z0vF0l.jpg')] bg-cover bg-center opacity-10"></div>
    <div class="relative w-full max-w-lg mx-4 p-6 bg-gray-900 bg-opacity-95 rounded-xl shadow-2xl shadow-red-600/50 border border-red-600/50">
        <h1 class="text-4xl text-yellow-400 neon-text text-center mb-6">Sketchy Flips Casino!</h1>
        
        <!-- Coin Animation -->
        <div id="coinContainer" class="coin-container flex mx-auto mb-6">
            <div class="coin mx-auto">
                <div class="coin-front">Heads</div>
                <div class="coin-back">Tails</div>
            </div>
        </div>
        
        <!-- Connect Wallet -->
        <button id="connectWallet" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-black font-bold py-3 px-6 rounded-lg border-2 border-red-700 shadow-lg shadow-yellow-500/60 hover:from-yellow-600 hover:to-orange-700 transition-all duration-300 mb-4">Connect Wallet</button>
        <p id="accountInfo" class="text-center text-lg mb-4 opacity-80">Account: Not connected</p>

        <!-- NFT Select -->
        <label class="block text-yellow-400 text-lg mb-2">Select NFT to Bet:</label>
        <select id="tokenSelect" class="w-full bg-gray-800 text-white p-3 rounded-lg mb-4 border border-gray-700 focus:outline-none focus:border-yellow-500 transition">
            <option value="">Connect wallet first</option>
        </select>

        <!-- Create Game Button -->
        <button id="betBtn" disabled class="w-full bg-gradient-to-r from-green-600 to-green-800 text-white font-bold py-3 px-6 rounded-lg border-2 border-red-700 shadow-lg shadow-green-500/60 hover:from-green-700 hover:to-green-900 transition-all duration-300 mb-6">Create Game (Bet NFT)</button>

        <!-- Open Games Lobby -->
        <h2 class="text-2xl text-yellow-400 neon-text text-center mb-4">Live Game Lobby</h2>
        <ul id="openGamesList" class="space-y-4 mb-6 max-h-64 overflow-y-auto bg-gray-800 p-4 rounded-lg border border-gray-700"></ul>
        <p class="text-center text-sm opacity-80 mb-4">Open games update live. Join any to flip!</p>

        <!-- Status -->
        <div id="status" class="text-center text-lg neon-text status-pulse">Status: Ready to Flip!</div>
    </div>

    <script>
        let provider, signer, account, gameContract, gameContractWithSigner, nftContract;
        const gameAddress = '0xf6b8d2E0d36669Ed82059713BDc6ACfABe11Fde6';
        const nftAddress = '0x08533a2b16e3db03eebd5b23210122f97dfcb97d';

        const gameABI = [
            "function createGame(uint256 tokenId)",
            "function joinGame(uint256 gameId, uint256 tokenId)",
            "function getOpenGames() view returns (uint256[])",
            "function getGame(uint256 gameId) view returns (tuple(address player1, uint256 tokenId1, address player2, uint256 tokenId2, bool active, uint256 requestId, bytes data, uint256 joinTimestamp, uint256 createTimestamp))",
            "event GameCreated(uint256 gameId, address player1, uint256 tokenId1)",
            "event GameJoined(uint256 gameId, address player2, uint256 tokenId2)",
            "event RandomnessRequested(uint256 gameId, uint256 requestId)",
            "event GameResolved(uint256 gameId, address winner, uint256 tokenId1, uint256 tokenId2)",
            "event GameCanceled(uint256 gameId)"
        ];

        const nftABI = [
            "function tokensOfOwner(address owner) view returns (uint256[])",
            "function approve(address to, uint256 tokenId)"
        ];

        let refreshInterval;

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function fetchUserTokens() {
            if (!nftContract || !account) return;
            const tokenSelect = document.getElementById('tokenSelect');
            tokenSelect.innerHTML = '<option value="">Loading NFTs...</option>';
            try {
                const tokens = await nftContract.tokensOfOwner(account);
                tokenSelect.innerHTML = tokens.length > 0
                    ? tokens.map(id => `<option value="${id.toString()}">NFT #${id.toString()}</option>`).join('')
                    : '<option value="">No NFTs owned</option>';
            } catch (error) {
                updateStatus(`Tokens fetch error: ${error.message}`);
                tokenSelect.innerHTML = '<option value="">Error loading NFTs</option>';
            }
        }

        async function fetchOpenGames() {
            if (!gameContract) return;
            const openGamesList = document.getElementById('openGamesList');
            openGamesList.innerHTML = '<li class="text-center opacity-80">Loading live games...</li>';
            try {
                const openIds = await gameContract.getOpenGames();
                if (openIds.length === 0) {
                    openGamesList.innerHTML = '<li class="text-center opacity-80">No open games. Create one!</li>';
                    return;
                }
                let listHTML = '';
                for (let id of openIds) {
                    const game = await gameContract.getGame(id);
                    const createdAt = new Date(game.createTimestamp * 1000).toLocaleTimeString();
                    listHTML += `
                        <li class="game-list-item bg-gray-700 p-3 rounded-lg flex justify-between items-center border border-gray-600 hover:border-yellow-500 transition-all duration-300">
                            <div>
                                <span class="font-bold">Game #${id}</span> | Player: ${game.player1.slice(0,6)}...${game.player1.slice(-4)}<br>
                                <span class="text-sm opacity-80">Bet: NFT #${game.tokenId1} | Created: ${createdAt}</span>
                            </div>
                            <button class="bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold py-2 px-4 rounded-lg border border-red-700 hover:from-blue-700 hover:to-blue-900 transition-all duration-300" onclick="joinGameFromList(${id})">Join</button>
                        </li>`;
                }
                openGamesList.innerHTML = listHTML;
            } catch (error) {
                updateStatus(`Error fetching games: ${error.message}`);
                openGamesList.innerHTML = '<li class="text-center text-red-500">Error loading games</li>';
            }
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) return updateStatus('Install MetaMask.');
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('accountInfo').textContent = `Account: ${account.slice(0,6)}...${account.slice(-4)}`;
                updateStatus('Wallet connected. Loading contracts...');
                
                gameContract = new ethers.Contract(gameAddress, gameABI, provider);
                gameContractWithSigner = gameContract.connect(signer);
                nftContract = new ethers.Contract(nftAddress, nftABI, signer);
                
                await fetchUserTokens();
                document.getElementById('betBtn').disabled = false;
                updateStatus('Connected! Fetching live games...');
                await fetchOpenGames();
                setupEventListeners();
                
                // Auto-refresh open games every 10 seconds for live feel
                refreshInterval = setInterval(fetchOpenGames, 10000);
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
            }
        });

        document.getElementById('betBtn').addEventListener('click', async () => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            const tokenId = document.getElementById('tokenSelect').value;
            if (!tokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, tokenId);
                await approveTx.wait();
                updateStatus('Approval done. Creating game...');

                const tx = await gameContractWithSigner.createGame(tokenId);
                await tx.wait();
                updateStatus('Game created! Waiting for join...');
                fetchOpenGames(); // Immediate refresh
                fetchUserTokens(); // Update NFTs after bet
            } catch (error) {
                updateStatus(`Error creating game: ${error.message}`);
            }
        });

        window.joinGameFromList = async (gameId) => {
            if (!gameContractWithSigner) return updateStatus('Connect wallet first.');
            const tokenId = document.getElementById('tokenSelect').value;
            if (!tokenId) return updateStatus('Select an NFT to bet.');
            try {
                updateStatus('Approving NFT...');
                const approveTx = await nftContract.approve(gameAddress, tokenId);
                await approveTx.wait();
                updateStatus('Approval done. Joining game...');

                const tx = await gameContractWithSigner.joinGame(gameId, tokenId);
                await tx.wait();
                updateStatus('Joined! Flipping coin...');
                document.getElementById('coinContainer').style.display = 'flex';
                const coin = document.querySelector('.coin');
                coin.style.animation = 'none'; // Reset animation
                setTimeout(() => { coin.style.animation = 'flip-coin 3s ease-in-out'; }, 10); // Trigger flip
                fetchOpenGames(); // Refresh list
                fetchUserTokens(); // Update NFTs
            } catch (error) {
                updateStatus(`Error joining: ${error.message}`);
            }
        };

        function setupEventListeners() {
            gameContract.on('GameCreated', (gameId, player1, tokenId1) => {
                updateStatus(`New game #${gameId} created by ${player1.slice(0,6)}...`);
                fetchOpenGames();
            });
            gameContract.on('GameJoined', (gameId, player2, tokenId2) => {
                updateStatus(`Game #${gameId} joined by ${player2.slice(0,6)}... Flipping...`);
                document.getElementById('coinContainer').style.display = 'flex';
                const coin = document.querySelector('.coin');
                coin.style.animation = 'none';
                setTimeout(() => { coin.style.animation = 'flip-coin 3s ease-in-out'; }, 10);
                fetchOpenGames();
            });
            gameContract.on('RandomnessRequested', (gameId, requestId) => {
                updateStatus(`Flip in progress for #${gameId}...`);
            });
            gameContract.on('GameResolved', (gameId, winner, tokenId1, tokenId2) => {
                updateStatus(`Game #${gameId} won by ${winner.slice(0,6)}...!`);
                document.getElementById('coinContainer').style.display = 'none';
                fetchOpenGames();
                fetchUserTokens();
            });
            gameContract.on('GameCanceled', (gameId) => {
                updateStatus(`Game #${gameId} canceled.`);
                fetchOpenGames();
                fetchUserTokens();
            });
        }

        // Stop interval on disconnect or page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>